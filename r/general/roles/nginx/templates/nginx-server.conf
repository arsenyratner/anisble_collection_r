{% if server.ssl.certificate is defined and certificate_result.stat.exists %}
{% if server.ssl.listens is defined %}
server {
    server_name {{ server.server_name }};
{% for listen in server.ssl.listens %}
    listen {{ listen }}; 
{% endfor %}
    ssl_certificate {{ server.ssl.certificate }}; 
    ssl_certificate_key {{ server.ssl.key }}; 
    access_log {{ server.access_log }}  main;
    error_log {{ server.error_log }};
    root   {{ server.root }};
    # include /etc/letsencrypt/options-ssl-nginx.conf; 
    # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; 

{% if server.locations is defined %}
{% for location in server.locations %}    
    location {{ location.location }} {
{% if location.alias is defined %}
	alias {{ location.alias }};
{% endif %}
{% if location.options is defined %}
{% for option in location.options %}    
	{{ option }};
{% endfor %}
{% endif %}
    }
{% endfor %}
{% endif %}
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   html;
    }
}
{% endif %}
{% endif %}
{% if server.listens is defined %}
server {
    server_name {{ server.server_name }};
{% for listen in server.listens %}
    listen {{ listen }};
{% endfor %}
    location /.well-known {
        alias {{ nginx_default_root }}/.well-known;
        allow all;
    }
{% if server.redirect_to_https | default(false) %}
    location / {
{% if server.server_name != '_' %}        
        return 301 https://$server_name$request_uri;
{% else %}
        return 301 https://$http_host$request_uri;
{% endif %}
    }
{% endif %}
{% if server.root is defined %}
    root {{ server.root }};
{% endif %}
{% if server.includes is defined %}
{% for include in server.includes %}
    include {{ include.file }};
{% endfor %}
{% endif %}
}
{% endif %}
